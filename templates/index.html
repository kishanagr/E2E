<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pro E2EE Sender — Admin</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <div class="panel">
      <h1>Pro E2EE Sender <span class="badge">Admin</span></h1>
      <p class="lead">Form fields explained below. Use Demo mode for local testing (safe). Paste your own E2E send logic in <code>send_to_uid()</code> when ready.</p>

      <form action="/start" method="post" enctype="multipart/form-data" id="mainForm">
        <label>Imgur Image Link (optional — direct image URL)</label>
        <input class="input" id="imgur_link" name="imgur_link" type="url" placeholder="https://i.imgur.com/abcd123.jpg">
        <div id="imgPreview" style="margin-top:10px;text-align:center;"></div>

        <label>Group UIDs (one per line or comma separated)</label>
        <textarea class="input" name="group_uids" placeholder="groupid1&#10;groupid2"></textarea>
        <div class="small">Example: 1234567890 or group-12345 (use the exact ID format you use)</div>

        <label>Inbox UIDs (one per line or comma separated)</label>
        <textarea class="input" name="inbox_uids" placeholder="userid1&#10;userid2"></textarea>
        <div class="small">Example: 111222333 (each line is one recipient)</div>

        <label>Message</label>
        <textarea class="input" name="message" placeholder="Message to send"></textarea>

        <label>Encryption Key (base64) — optional</label>
        <input class="input" name="encryption_key" type="text" placeholder="Paste your base64 E2E key here (optional)">

        <div class="row">
          <div style="flex:1">
            <label>Start Time</label>
            <input class="input" name="time_to_send" type="datetime-local" required>
          </div>
          <div style="width:130px">
            <label>Interval (sec)</label>
            <input class="input" name="interval" type="number" value="60" min="5" required>
          </div>
        </div>

        <label><input type="checkbox" name="demo_mode" checked> Demo mode (post to local /receive and show logs)</label>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-primary" type="submit">Start Sending</button>
          <button class="btn btn-ghost" formaction="/stop" formmethod="post">Stop</button>
        </div>
      </form>

      <div style="margin-top:12px" class="small">
        Quick test webhook: <code>http://localhost:5000/receive</code>. Use <a href="/decrypt">Decrypt</a> page to verify payloads. <strong>Where to put what:</strong>
        <ul>
          <li><strong>Group UIDs</strong> — paste target group IDs (one per line)</li>
          <li><strong>Inbox UIDs</strong> — paste recipient user IDs (one per line)</li>
          <li><strong>Message</strong> — the plain text message you want to send</li>
          <li><strong>Encryption Key</strong> — optional: your own base64 E2E key (if you have it legally)</li>
        </ul>
      </div>
    </div>

    <div class="right">
      <div class="status">Status: <strong id="st">Idle</strong></div>
      <div class="small">Last activity</div>
      <div id="log" class="logbox"></div>
      <div class="footer">Pro E2EE Sender — Use only with keys/accounts you own. Unauthorized use illegal.</div>
      <div style="margin-top:8px"><a class="btn btn-ghost" href="/logout">Logout</a></div>
    </div>
  </div>

<script>
async function pollStatus(){
  try{
    let r = await fetch('/status');
    let j = await r.json();
    document.getElementById('st').innerText = j.sending ? 'Sending' : 'Idle';
    let log = document.getElementById('log');
    log.innerHTML = j.log.slice().reverse().map(l => `<div>${l}</div>`).join('');
  }catch(e){}
  setTimeout(pollStatus,1500);
}
pollStatus();

document.getElementById('imgur_link').addEventListener('input', function(e){
  const url = e.target.value.trim();
  const preview = document.getElementById('imgPreview');
  if(!url){ preview.innerHTML = ''; return; }
  if(url.match(/\.(jpg|jpeg|png|gif|webp)$/i)){
    preview.innerHTML = `<img src="${url}" alt="imgur-preview" style="max-width:100%;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.5)">`;
  } else {
    preview.innerHTML = `<div class="small">Provide direct image link (ends with .jpg/.png/.webp)</div>`;
  }
});
</script>
</body>
  </html>
